# Data Documentation Index

[← Back to Architecture Index](../architecture/00_INDEX.md)

## Overview

This section documents CloudVault's data layer: database schema, migrations, storage patterns, and data invariants.

## Quick Reference

### Database

- **Type**: PostgreSQL
- **ORM**: Drizzle
- **Schema**: [shared/schema.ts](../../shared/schema.ts)
- **Migrations**: Drizzle Kit (`npm run db:push`)
- **Connection**: Single pool, lazy initialization

### Tables

| Table         | Purpose                        | Row Count (typical) |
| ------------- | ------------------------------ | ------------------- |
| `users`       | User accounts from Replit Auth | 1-10k               |
| `sessions`    | Active login sessions          | 10-100 per user     |
| `folders`     | Hierarchical folder structure  | 10-1k per user      |
| `files`       | File metadata (not blobs)      | 100-10k per user    |
| `share_links` | Shareable access tokens        | 1-10 per file       |

## Schema Documentation

### Users Table

**File**: `shared/models/auth.ts`

**Purpose**: Store user accounts synced from Replit Auth.

**Columns**:

```typescript
{
  id: varchar (primary key) - Replit user ID (sub claim)
  username: text - Replit username
  name: text - Display name
  email: text - Email address
  profileImageUrl: text - Avatar URL
  createdAt: timestamp - Account creation time
}
```

**Indexes**: Primary key on `id`

**Relations**:

- One user → many folders
- One user → many files

**Evidence**: [shared/models/auth.ts](../../shared/models/auth.ts)

### Sessions Table

**File**: `shared/models/auth.ts`

**Purpose**: Store Express session data for authentication.

**Columns**:

```typescript
{
  sid: varchar (primary key) - Session ID (cookie value)
  sess: json - Session data (user claims, etc.)
  expire: timestamp - Expiration time
}
```

**Indexes**:

- Primary key on `sid`
- Index on `expire` (for cleanup queries)

**Managed by**: `connect-pg-simple` (express-session store)

**Evidence**: [shared/models/auth.ts](../../shared/models/auth.ts)

### Folders Table

**File**: `shared/schema.ts:18-27`

**Purpose**: Hierarchical folder structure per user.

**Columns**:

```typescript
{
  id: varchar (primary key) - UUID (gen_random_uuid)
  name: text - Folder name
  parentId: varchar (nullable) - Parent folder ID (null = root)
  userId: varchar - Owner user ID
  createdAt: timestamp - Creation time
}
```

**Indexes**:

- Primary key on `id`
- Index on `userId` (find user's folders)
- Index on `parentId` (find subfolders)

**Relations**:

- Self-referential: `parentId` → `folders.id`
- One folder → many subfolders
- One folder → many files

**Invariants**:

- Root folders have `parentId = NULL`
- No circular references (enforced by application)
- All folders must have valid `userId`

**Evidence**: [shared/schema.ts](../../shared/schema.ts):18-36

### Files Table

**File**: `shared/schema.ts:38-50`

**Purpose**: File metadata (not the actual blob data).

**Columns**:

```typescript
{
  id: varchar (primary key) - UUID
  name: text - File name
  size: bigint - File size in bytes
  mimeType: text - MIME type (e.g., "image/png")
  objectPath: text - Key in object storage
  folderId: varchar (nullable) - Parent folder (null = root)
  userId: varchar - Owner user ID
  createdAt: timestamp - Upload time
}
```

**Indexes**:

- Primary key on `id`
- Index on `userId` (find user's files)
- Index on `folderId` (find folder's files)

**Relations**:

- `folderId` → `folders.id`
- One file → many share links

**Invariants**:

- `objectPath` must point to existing blob in GCS
- `size` must be positive
- `mimeType` should be valid MIME type

**Evidence**: [shared/schema.ts](../../shared/schema.ts):38-58

### Share Links Table

**File**: `shared/schema.ts:60-72`

**Purpose**: Token-based temporary file access.

**Columns**:

```typescript
{
  id: varchar (primary key) - UUID
  fileId: varchar - File being shared
  token: varchar (unique) - Random access token
  expiresAt: timestamp (nullable) - Expiration time (null = never)
  password: text (nullable) - Hashed password (bcrypt)
  downloadCount: bigint - Number of downloads
  isActive: boolean - Whether link is active
  createdAt: timestamp - Link creation time
}
```

**Indexes**:

- Primary key on `id`
- Unique index on `token` (fast lookup by URL)
- Index on `fileId` (list links for file)

**Relations**:

- `fileId` → `files.id`

**Invariants**:

- `token` must be unique (64 hex chars)
- `password` must be bcrypt hash or null (never plain text)
- `downloadCount` must be non-negative
- Expired links (`expiresAt < now`) should not be served

**Evidence**: [shared/schema.ts](../../shared/schema.ts):60-79

## Schema Design Patterns

### 1. UUID Primary Keys

All tables use UUID primary keys generated by PostgreSQL:

```typescript
id: varchar('id')
  .primaryKey()
  .default(sql`gen_random_uuid()`)
```

**Rationale**:

- Prevents ID enumeration attacks
- Safe to expose in URLs
- Compatible with distributed systems

### 2. Hierarchical Data (Folders)

Folders use **adjacency list** pattern:

```typescript
parentId: varchar('parent_id') // Points to parent folder
```

**Pros**: Simple to insert/update
**Cons**: Slow for deep path queries (see `getFolderPath`)

**Alternative (not implemented)**: Materialized path or nested sets

### 3. Soft Deletes (Share Links)

Share links use `isActive` flag for soft deletion:

```typescript
isActive: boolean('is_active').default(true)
```

**Rationale**: Preserve history, allow reactivation

**Note**: Folders/files use hard deletes (actual DELETE queries)

### 4. Timestamps

All tables include `createdAt`:

```typescript
createdAt: timestamp('created_at').defaultNow()
```

**Missing**: `updatedAt` (not implemented)

### 5. Foreign Keys

Foreign keys enforced by **application logic**, not database constraints.

**Example**: `folders.parentId` → `folders.id` relation defined in Drizzle schema but not as FK constraint.

**Rationale**: Flexibility for cascade deletes in application code

## Migrations

### Running Migrations

```bash
# Push schema changes to database
npm run db:push
```

**What it does**:

1. Compares `shared/schema.ts` to database
2. Generates SQL ALTER statements
3. Executes SQL on database
4. Updates `migrations/` directory

**Warning**: `db:push` is destructive. For production, use `drizzle-kit generate` + `drizzle-kit migrate`.

### Migration Files

**Location**: `migrations/` (auto-generated)

**Format**: SQL files with timestamps

**Example**: `0000_create_folders.sql`

**Not committed**: `migrations/` should be in `.gitignore` (check this)

### Schema Change Process

1. **Edit schema**: Modify `shared/schema.ts`
2. **Type check**: Run `npm run check`
3. **Push to dev DB**: Run `npm run db:push`
4. **Test**: Verify changes work
5. **Commit**: Commit `shared/schema.ts` change
6. **Deploy**: Run `npm run db:push` in production

**Caution**: Breaking changes (e.g., removing column) require data migration script.

## Data Access Patterns

### 1. Always Filter by userId

**Rule**: All queries must filter by `userId` to prevent unauthorized access.

**Good**:

```typescript
await db.select().from(folders).where(eq(folders.userId, userId))
```

**Bad** (security vulnerability):

```typescript
await db.select().from(folders).where(eq(folders.id, folderId))
// Missing userId check!
```

**Enforcement**: Code review and testing

### 2. Use Storage Abstraction

**Rule**: Routes should call `storage.*` methods, not `db.*` directly.

**Good**:

```typescript
// In routes.ts
const folders = await storage.getFoldersByParent(userId, parentId)
```

**Bad**:

```typescript
// In routes.ts
const folders = await db.select().from(folders)... // Too low-level
```

**Rationale**: Centralize data access logic in `storage.ts`

### 3. Cascade Deletes in Code

**Rule**: Deleting parent records must manually delete children.

**Example**: `storage.deleteFolder()` recursively deletes subfolders and files.

**Evidence**: [server/storage.ts](../../server/storage.ts):80-93

**Caution**: No database-level cascades, easy to create orphans if not careful.

### 4. Transactions (Not Used)

**Current state**: No transactions implemented.

**Risk**: Partial failures can leave inconsistent state (e.g., half-deleted folder tree).

**Recommendation**: Wrap multi-step operations in transactions:

```typescript
await db.transaction(async tx => {
  // Delete operations
})
```

## Storage Layer

### Object Storage (Google Cloud Storage)

**What's stored**: Actual file blobs (binary data)

**What's NOT in database**: File contents (only metadata)

**Bucket structure**:

```
bucket/
  user_abc123/
    file_xyz789/
      document.pdf
    file_def456/
      image.png
```

**Path format**: `{userId}/{fileId}/{filename}`

**Access method**: Presigned URLs (temporary, signed by GCS)

**Evidence**: [server/replit_integrations/object_storage/service.ts](../../server/replit_integrations/object_storage/service.ts)

### Object Storage vs Database

| Data        | Stored In      | Reason                          |
| ----------- | -------------- | ------------------------------- |
| File name   | Database       | Fast queries, searchable        |
| File size   | Database       | Quick stats calculation         |
| MIME type   | Database       | Content-Type header             |
| File blob   | Object Storage | Scalable, cheap for large files |
| Object path | Database       | Links blob to metadata          |

## Data Invariants

### Critical Invariants (Must Never Violate)

1. **User isolation**: User A must never see User B's files/folders
2. **Share link security**: Expired or inactive links must not grant access
3. **Password hashing**: Share link passwords must be bcrypt hashed
4. **Object path validity**: `files.objectPath` must point to existing GCS object

### Soft Invariants (Should Maintain)

1. **No orphaned files**: Every `files.folderId` should point to existing folder (or be NULL)
2. **No orphaned share links**: Every `shareLinks.fileId` should point to existing file
3. **Consistent hierarchy**: No circular folder references
4. **Non-negative counts**: `downloadCount` should be >= 0

### Invariant Enforcement

- **Authentication**: `isAuthenticated` middleware on all API routes
- **Authorization**: `userId` filter in all queries
- **Validation**: Zod schemas on API inputs
- **Hashing**: bcrypt.hash() before storing passwords
- **Manual checks**: Code review for data access patterns

## Database Performance

### Indexes

All critical foreign keys have indexes:

- `folders.userId` - Find user's folders
- `folders.parentId` - Find subfolders
- `files.userId` - Find user's files
- `files.folderId` - Find folder's files
- `shareLinks.token` - Fast share link lookup
- `shareLinks.fileId` - List share links for file

### Slow Queries

**Folder path traversal** (`getFolderPath`):

```typescript
// Current: Iterative queries up parent chain
while (currentId) {
  const folder = await db.select()...
  currentId = folder.parentId;
}
```

**Problem**: N+1 query (one query per folder level)

**Solution**: Use PostgreSQL WITH RECURSIVE:

```sql
WITH RECURSIVE path AS (
  SELECT * FROM folders WHERE id = $1
  UNION ALL
  SELECT f.* FROM folders f JOIN path p ON f.id = p.parent_id
)
SELECT * FROM path;
```

**Evidence**: [server/storage.ts](../../server/storage.ts):60-73

### Connection Pooling

- **Pool size**: Default (10 connections)
- **Idle timeout**: Default
- **Max lifetime**: Default

**Evidence**: [server/db.ts](../../server/db.ts) (pg.Pool configuration)

## Backup & Recovery

**Current state**: Not implemented in application code.

**Recommendations**:

1. **Replit-managed PostgreSQL**: Backups handled by Replit
2. **Manual backups**: `pg_dump` for local development
3. **Disaster recovery**: No documented process

## Evidence

Key files implementing data layer:

- [shared/schema.ts](../../shared/schema.ts) - Complete schema definition
- [shared/models/auth.ts](../../shared/models/auth.ts) - User and session tables
- [server/db.ts](../../server/db.ts) - Database connection
- [server/storage.ts](../../server/storage.ts) - Data access layer
- [drizzle.config.ts](../../drizzle.config.ts) - Migration configuration
- [server/replit_integrations/object_storage/service.ts](../../server/replit_integrations/object_storage/service.ts) - Object storage interface

## Related Documentation

- [Architecture Overview](../architecture/10_OVERVIEW.md) - System design
- [Key Flows](../architecture/40_KEY_FLOWS.md) - Data flow through system
- [API Documentation](../api/00_INDEX.md) - Endpoints that access data
- [Glossary](../architecture/90_GLOSSARY.md) - Database terms

[← Back to Architecture Index](../architecture/00_INDEX.md)
